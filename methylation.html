<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DNA Methylation Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 1100px;
        }
        h1 {
            text-align: left;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .search-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f8f8f8;
        }
        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .input-group label {
            min-width: 90px;
        }
        select, input {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"], input[type="number"] {
            width: 150px;
        }
        select {
            width: 150px;
        }
        .flanking-region {
            margin: 10px 0;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
        }
        .flanking-region label {
            margin-right: 18px;
            cursor: pointer;
        }
        button {
            padding: 7px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background-color: #228B22;
            color: #fff;
            font-size: 14px;
        }
        button:hover {
            background-color: #1a6b1a;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            font-size: 13px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #errorMessage {
            color: red;
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        .pagination {
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        h3 {
            margin-top: 20px;
        }
                .page-info {
            margin-top: 10px;
            font-size: 13px;
            color: #555;
        }
        .pagination {
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .page-number-btn {
            border: 1px solid #ccc;
            background: #fff;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
        }
        .page-number-btn.active {
            background: #228B22;
            color: #fff;
            border-color: #228B22;
        }
        .page-number-btn.disabled {
            opacity: 0.5;
            cursor: default;
        }

    </style>
</head>
<body>
<div class="container">
    <h1>DNA Methylation Search</h1>

    <div class="search-section">
        <!-- Context -->
        <div class="input-group">
            <label for="context">Context:</label>
            <select id="context">
                <option value="CG">CG</option>
                <option value="CHG">CHG</option>
                <option value="CHH">CHH</option>
            </select>
        </div>

        <!-- Gene search -->
        <div class="input-group">
            <label for="geneId">Gene ID:</label>
            <input type="text" id="geneId" placeholder="e.g. Pgi01A00000020">
            <button onclick="searchGeneMethylation()">Search Gene</button>
            <button onclick="fillExampleGene()">Example</button>
        </div>

        <!-- Flanking region -->
        <div class="flanking-region">
            <span>Flanking Region:</span>
            <label><input type="radio" name="flankingRegion" value="0" checked> ±0 kb</label>
            <label><input type="radio" name="flankingRegion" value="1"> ±1 kb</label>
            <label><input type="radio" name="flankingRegion" value="2"> ±2 kb</label>
            <label><input type="radio" name="flankingRegion" value="3"> ±3 kb</label>
        </div>

        <!-- Region search -->
        <div class="input-group">
            <label for="chr">Chromosome:</label>
            <input type="text" id="chr" placeholder="e.g. Chr05A">
            <label for="start">Start:</label>
            <input type="number" id="start" placeholder="Start position">
            <label for="end">End:</label>
            <input type="number" id="end" placeholder="End position">
            <button onclick="fillExample()">Example</button>
        </div>

        <div class="input-group" style="justify-content:flex-start;">
            <button onclick="searchMethylation()">Search Region</button>
            <button id="downloadBtn" class="hidden" onclick="downloadTable()">Download Table</button>
        </div>
    </div>

    <div id="errorMessage"></div>
    <div id="results"></div>

        <div id="pageInfo" class="page-info hidden"></div>

    <div id="pagination" class="pagination hidden">
        <button id="prevPageBtn" onclick="previousPage()">Previous</button>
        <span id="pageNumbers"></span>
        <button id="nextPageBtn" onclick="nextPage()">Next</button>
    </div>
</div> <!-- container 结束 -->



<script>
    // 分页相关全局变量
    let currentPage = 1;
    const rowsPerPage = 10;
    let tableData = [];

    // 甲基化表头（注意要和后端 CSV 列名一致）
    const headers = ["chr", "start", "end", "strand", "context", "Leaf", "Root"];

    function clearErrorAndResults() {
        const err = document.getElementById('errorMessage');
        const resultsDiv = document.getElementById('results');
        if (err) {
            err.style.display = 'none';
            err.textContent = '';
        }
        if (resultsDiv) {
            resultsDiv.innerHTML = '';
        }
    }

    function getFlankingRegion() {
        const selected = document.querySelector('input[name="flankingRegion"]:checked');
        // 转成 bp：0/1/2/3 kb -> 0/1000/2000/3000
        return selected ? parseInt(selected.value) * 1000 : 0;
    }

    function updateSearchRange(geneStart, geneEnd) {
        const buffer = getFlankingRegion();
        document.getElementById('start').value = Math.max(0, parseInt(geneStart) - buffer);
        document.getElementById('end').value = parseInt(geneEnd) + buffer;
    }

    function fillExample() {
        document.getElementById('chr').value = 'Chr05A';
        document.getElementById('start').value = '6000';
        document.getElementById('end').value = '11000';
        clearErrorAndResults();
    }

    function fillExampleGene() {
        document.getElementById('geneId').value = 'Pgi01A00000020';
        clearErrorAndResults();
    }

    function generateTable(data, headers) {
        const container = document.createElement('div');
        container.className = 'table-container';

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        const headerRow = document.createElement('tr');
        headers.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(h => {
                const td = document.createElement('td');
                let value = row[h];

                // 简单数值格式处理（可选）
                if (typeof value === 'number') {
                    if (['start', 'end'].includes(h)) {
                        value = Math.round(value);
                    } else {
                        // 例如 Leaf / Root 如果是小数，可以保留 4 位
                        value = Number(value).toFixed(4);
                    }
                }

                td.textContent = value != null ? value : "";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        container.appendChild(table);
        return container;
    }

        function displayPage() {
        const resultsDiv = document.getElementById('results');
        const oldTable = resultsDiv.querySelector('.table-container');
        if (oldTable) {
            resultsDiv.removeChild(oldTable);
        }

        if (!tableData || tableData.length === 0) {
            document.getElementById('pagination').classList.add('hidden');
            document.getElementById('pageInfo').classList.add('hidden');
            return;
        }

        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const pageData = tableData.slice(startIndex, endIndex);

        const table = generateTable(pageData, headers);
        resultsDiv.appendChild(table);

        updatePaginationControls();
    }

        function updatePaginationControls() {
        const total = tableData.length;
        const totalPages = Math.ceil(total / rowsPerPage);
        const pageInfoDiv = document.getElementById('pageInfo');
        const paginationDiv = document.getElementById('pagination');
        const pageNumbersSpan = document.getElementById('pageNumbers');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');

        if (total === 0) {
            pageInfoDiv.classList.add('hidden');
            paginationDiv.classList.add('hidden');
            return;
        }

        const startEntry = (currentPage - 1) * rowsPerPage + 1;
        const endEntry = Math.min(currentPage * rowsPerPage, total);
        pageInfoDiv.textContent = `Showing ${startEntry} to ${endEntry} of ${total} entries`;
        pageInfoDiv.classList.remove('hidden');
        paginationDiv.classList.remove('hidden');

        // Previous / Next 按钮状态
        if (currentPage === 1) {
            prevBtn.classList.add('disabled');
            prevBtn.disabled = true;
        } else {
            prevBtn.classList.remove('disabled');
            prevBtn.disabled = false;
        }

        if (currentPage === totalPages) {
            nextBtn.classList.add('disabled');
            nextBtn.disabled = true;
        } else {
            nextBtn.classList.remove('disabled');
            nextBtn.disabled = false;
        }

        // 生成数字页码
        pageNumbersSpan.innerHTML = "";

        function createPageButton(page) {
            const btn = document.createElement('button');
            btn.textContent = page;
            btn.className = 'page-number-btn' + (page === currentPage ? ' active' : '');
            btn.addEventListener('click', function () {
                if (page !== currentPage) {
                    currentPage = page;
                    displayPage();
                }
            });
            pageNumbersSpan.appendChild(btn);
        }

        function createEllipsis() {
            const span = document.createElement('span');
            span.textContent = '...';
            pageNumbersSpan.appendChild(span);
        }

        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) {
                createPageButton(i);
            }
        } else {
            // 总页数多时：1 2 3 ... 15 16 这种格式
            if (currentPage <= 4) {
                for (let i = 1; i <= 5; i++) {
                    createPageButton(i);
                }
                createEllipsis();
                createPageButton(totalPages);
            } else if (currentPage >= totalPages - 3) {
                createPageButton(1);
                createEllipsis();
                for (let i = totalPages - 4; i <= totalPages; i++) {
                    createPageButton(i);
                }
            } else {
                createPageButton(1);
                createEllipsis();
                for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                    createPageButton(i);
                }
                createEllipsis();
                createPageButton(totalPages);
            }
        }
    }


        function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            displayPage();
        }
    }

    function nextPage() {
        const maxPage = Math.ceil(tableData.length / rowsPerPage);
        if (currentPage < maxPage) {
            currentPage++;
            displayPage();
        }
    }


    // 区间搜索
    async function searchMethylation() {
        const chr = document.getElementById('chr').value.trim();
        const start = document.getElementById('start').value.trim();
        const end = document.getElementById('end').value.trim();
        const context = document.getElementById('context').value;

        const err = document.getElementById('errorMessage');
        const resultsDiv = document.getElementById('results');
        const downloadBtn = document.getElementById('downloadBtn');

        clearErrorAndResults();

        if (!chr || !start || !end) {
            err.textContent = "Please input chromosome, start and end.";
            err.style.display = 'block';
            return;
        }

        try {
            const url = `/search_methylation?chr=${encodeURIComponent(chr)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&context=${encodeURIComponent(context)}`;
            const resp = await fetch(url);
            const data = await resp.json();

            if (!resp.ok || data.error) {
                err.textContent = "Error: " + (data.error || `HTTP ${resp.status}`);
                err.style.display = 'block';
                resultsDiv.innerHTML = "";
                downloadBtn.classList.add('hidden');
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            resultsDiv.innerHTML = "<h3>Region Search Results:</h3>";

            if (!data.length) {
                resultsDiv.innerHTML += "<p>No methylation records in this region.</p>";
                downloadBtn.classList.add('hidden');
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            tableData = data;
            currentPage = 1;
            displayPage();
            downloadBtn.classList.remove('hidden');

        } catch (e) {
            err.textContent = "Error: " + e.message;
            err.style.display = 'block';
        }
    }

    // 基因搜索
    async function searchGeneMethylation() {
        const geneId = document.getElementById('geneId').value.trim();
        const context = document.getElementById('context').value;
        const buffer = getFlankingRegion();  // 单位已经是 bp
        const err = document.getElementById('errorMessage');
        const resultsDiv = document.getElementById('results');
        const downloadBtn = document.getElementById('downloadBtn');

        clearErrorAndResults();

        if (!geneId) {
            err.textContent = "Please input a Gene ID.";
            err.style.display = 'block';
            return;
        }

        try {
            const url = `/search_gene_methylation?gene_id=${encodeURIComponent(geneId)}&context=${encodeURIComponent(context)}&buffer=${buffer}`;
            const resp = await fetch(url);
            const data = await resp.json();

            if (!resp.ok || data.error) {
                err.textContent = "Error: " + (data.error || `HTTP ${resp.status}`);
                err.style.display = 'block';
                resultsDiv.innerHTML = "";
                downloadBtn.classList.add('hidden');
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            const g = data.gene_info;
            if (!g) {
                err.textContent = "No gene information found for this Gene ID.";
                err.style.display = 'block';
                return;
            }

            // Gene 信息表
            resultsDiv.innerHTML = "";
            const h3Gene = document.createElement('h3');
            h3Gene.textContent = "Gene Information";
            resultsDiv.appendChild(h3Gene);

            const geneTable = document.createElement('table');
            geneTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Gene ID</th>
                        <th>Description</th>
                        <th>Chromosome</th>
                        <th>Start</th>
                        <th>End</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${g.gene_id}</td>
                        <td>${g.description || "N/A"}</td>
                        <td>${g.chr}</td>
                        <td>${g.start}</td>
                        <td>${g.end}</td>
                    </tr>
                </tbody>
            `;
            resultsDiv.appendChild(geneTable);

            // 把基因 chr 填到输入框，并根据 flanking 自动扩展 start/end
            document.getElementById('chr').value = g.chr;
            updateSearchRange(g.start, g.end);

            // Methylation windows
            const windows = data.windows || [];
            const h3Win = document.createElement('h3');
            h3Win.textContent = "Methylation Windows Overlapping This Gene (with flanking)";
            resultsDiv.appendChild(h3Win);

            if (!windows.length) {
                const p = document.createElement('p');
                p.textContent = "No methylation windows found for this gene region.";
                resultsDiv.appendChild(p);
                downloadBtn.classList.add('hidden');
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            tableData = windows;
            currentPage = 1;
            displayPage();
            downloadBtn.classList.remove('hidden');

        } catch (e) {
            err.textContent = "Error: " + e.message;
            err.style.display = 'block';
        }
    }

    function downloadTable() {
        if (!tableData || !tableData.length) return;

        const csvRows = [];
        csvRows.push(headers.join(","));
        tableData.forEach(row => {
            const line = headers.map(h => {
                let value = row[h];
                if (typeof value === 'number') {
                    if (['start', 'end'].includes(h)) {
                        value = Math.round(value);
                    } else {
                        value = Number(value).toFixed(4);
                    }
                }
                return value != null ? value : "";
            }).join(",");
            csvRows.push(line);
        });

        const csvContent = "data:text/csv;charset=utf-8," + csvRows.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "methylation_results.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 回车键行为：在 Gene ID 里回车 -> 基因搜索；否则 -> 区间搜索
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            const active = document.activeElement;
            const geneIdInput = document.getElementById('geneId');
            if (active === geneIdInput && geneIdInput.value.trim()) {
                searchGeneMethylation();
            } else {
                searchMethylation();
            }
        }
    });

    // flanking 选项改变时，如果已经有 start/end，就重新按照新 flanking 更新区间
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('input[name="flankingRegion"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const start = document.getElementById('start').value;
                const end = document.getElementById('end').value;
                // 如果是从基因搜索过来的，start/end 会是基因±旧 flanking
                // 这里简单地在重新搜索基因时会用新的 flanking，所以这里只更新 UI 不再复杂处理
            });
        });
    });
</script>
</body>
</html>
